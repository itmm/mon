<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Disassembler</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Disassembler</h1>
<div class="slides">
<div class="page page-header">
<div class="slide slide-header"><div class="slide-nr">1</div><div class="headers">
<h1>Disassembler</h1>
</div></div>
<ul><li>
disassembles an instruction
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">2</div>
<code>
<span class="macro">@Add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">write_hex_int</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">value</span>, <span class="type">int</span> <span class="var">bytes</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">write hex int</span>)</span><br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
writes a hexadecimal <code><span class="var">value</span></code>
</li><li>
only the lowest <code><span class="var">bytes</span></code> of <code><span class="var">value</span></code> are written
</li><li>
if <code><span class="var">bytes</span></code> is negative, enough bytes will be written to fit the  value
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">3</div>
<code>
<span class="macro">@def(<span class="name">write hex int</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">bytes</span> &lt; <span class="num">0</span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">write dynamic hex int</span>)</span><br/>
<span class="in2"></span><span class="keyword">return</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">write hex int</span>)</span><br/>
</code></div>
<ul><li>
write dynamic number of bytes
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">4</div>
<code>
<span class="macro">@add(<span class="name">write hex int</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (; <span class="var">bytes</span>; --<span class="var">bytes</span>) {<br/>
<span class="in2"></span><span class="fn">write_hex_byte</span>(<br/>
<span class="in3"></span>(<span class="var">value</span> &gt;&gt; (<span class="num">8</span> * (<span class="var">bytes</span> - <span class="num">1</span>))) &amp;<br/>
<span class="in3"></span><span class="num">0xff</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">write hex int</span>)</span><br/>
</code></div>
<ul><li>
write as many hexadecimal bytes as specified
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">5</div>
<code>
<span class="macro">@def(<span class="name">write dynamic hex int</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">value</span> &lt; <span class="num">256</span>) {<br/>
<span class="in2"></span><span class="fn">write_hex_int</span>(<span class="var">value</span>, <span class="num">1</span>);<br/>
<span class="in1"></span>} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="var">value</span> &lt; <span class="num">0x10000</span>) {<br/>
<span class="in2"></span><span class="fn">write_hex_int</span>(<span class="var">value</span>, <span class="num">2</span>);<br/>
<span class="in1"></span>} <span class="keyword">else</span> {<br/>
<span class="in2"></span><span class="fn">write_hex_int</span>(<span class="var">value</span>, <span class="num">4</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">write dynamic hex int</span>)</span><br/>
</code></div>
<ul><li>
write <code><span class="num">1</span></code>, <code><span class="num">2</span></code> or <code><span class="num">4</span></code> bytes, depending on <code><span class="var">value</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">6</div>
<code>
<span class="macro">@Add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">write_reg</span>(<span class="type">int</span> <span class="var">reg</span>) {<br/>
<span class="in2"></span><span class="keyword">switch</span> (<span class="var">reg</span>) {<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">write reg cases</span>)</span><br/>
<span class="in3"></span><span class="keyword">default</span>:<br/>
<span class="in4"></span><span class="fn">put</span>(<span class="str">"?? # "</span>);<br/>
<span class="in4"></span><span class="fn">write_int</span>(<span class="var">reg</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
write the name of a register
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">7</div>
<code>
<span class="macro">@def(<span class="name">write reg cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">0</span>: <span class="fn">put</span>(<span class="str">"%zero"</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">1</span>: <span class="fn">put</span>(<span class="str">"%ra"</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">2</span>: <span class="fn">put</span>(<span class="str">"%sp"</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">3</span>: <span class="fn">put</span>(<span class="str">"%gp"</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">4</span>: <span class="fn">put</span>(<span class="str">"%tp"</span>); <span class="keyword">break</span>;<br/>
<span class="macro">@end(<span class="name">write reg cases</span>)</span><br/>
</code></div>
<ul><li>
write named registers
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">8</div>
<code>
<span class="macro">@add(<span class="name">write reg cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">5</span>: <span class="keyword">case</span> <span class="num">6</span>: <span class="keyword">case</span> <span class="num">7</span>:<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"%t"</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">'0'</span> + <span class="var">reg</span> - <span class="num">5</span>);<br/>
<span class="in2"></span><span class="keyword">break</span>;<br/>
<span class="macro">@end(<span class="name">write reg cases</span>)</span><br/>
</code></div>
<ul><li>
first temporary registers
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">9</div>
<code>
<span class="macro">@add(<span class="name">write reg cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">8</span>: <span class="keyword">case</span> <span class="num">9</span>:<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"%s"</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">'0'</span> + <span class="var">reg</span> - <span class="num">8</span>);<br/>
<span class="in2"></span><span class="keyword">break</span>;<br/>
<span class="macro">@end(<span class="name">write reg cases</span>)</span><br/>
</code></div>
<ul><li>
first saved registers
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">10</div>
<code>
<span class="macro">@add(<span class="name">write reg cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">10</span>: <span class="keyword">case</span> <span class="num">11</span>: <span class="keyword">case</span> <span class="num">12</span>:<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">13</span>: <span class="keyword">case</span> <span class="num">14</span>: <span class="keyword">case</span> <span class="num">15</span>:<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">16</span>: <span class="keyword">case</span> <span class="num">17</span>:<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"%a"</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">'0'</span> + <span class="var">reg</span> - <span class="num">10</span>);<br/>
<span class="in2"></span><span class="keyword">break</span>;<br/>
<span class="macro">@end(<span class="name">write reg cases</span>)</span><br/>
</code></div>
<ul><li>
argument registers
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">11</div>
<code>
<span class="macro">@add(<span class="name">write reg cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">18</span>: <span class="keyword">case</span> <span class="num">19</span>: <span class="keyword">case</span> <span class="num">20</span>:<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">21</span>: <span class="keyword">case</span> <span class="num">22</span>: <span class="keyword">case</span> <span class="num">23</span>:<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">24</span>: <span class="keyword">case</span> <span class="num">25</span>: <span class="keyword">case</span> <span class="num">26</span>:<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">27</span>:<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"%s"</span>);<br/>
<span class="in2"></span><span class="fn">write_int</span>(<span class="var">reg</span> - <span class="num">18</span> + <span class="num">2</span>);<br/>
<span class="in2"></span><span class="keyword">break</span>;<br/>
<span class="macro">@end(<span class="name">write reg cases</span>)</span><br/>
</code></div>
<ul><li>
second saved registers
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">12</div>
<code>
<span class="macro">@add(<span class="name">write reg cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">28</span>: <span class="keyword">case</span> <span class="num">29</span>: <span class="keyword">case</span> <span class="num">30</span>:<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="num">31</span>:<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"%t"</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">'0'</span> + <span class="var">reg</span> - <span class="num">31</span> + <span class="num">3</span>);<br/>
<span class="in2"></span><span class="keyword">break</span>;<br/>
<span class="macro">@end(<span class="name">write reg cases</span>)</span><br/>
</code></div>
<ul><li>
second temporary registers
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">13</div>
<code>
<span class="macro">@Def(<span class="name">disassemble</span>)</span><br/>
<span class="in1"></span><span class="macro">@Mul(<span class="name">clear whole line</span>)</span><br/>
<span class="in1"></span><span class="fn">write_addr</span>(<span class="var">addr</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">"  "</span>);<br/>
<span class="macro">@End(<span class="name">disassemble</span>)</span><br/>
</code></div>
<ul><li>
clear line and write address
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">14</div>
<code>
<span class="macro">@Add(<span class="name">disassemble</span>)</span><br/>
<span class="in1"></span><span class="type">const</span> <span class="type">auto</span> <span class="var">bytes</span> { <span class="var">reinterpret_cast</span>&lt;<br/>
<span class="in2"></span><span class="var">uchr</span> *<br/>
<span class="in1"></span>&gt;(<span class="var">addr</span>) };<br/>
<span class="in1"></span><span class="type">unsigned</span> <span class="var">cmd</span> { <span class="num">0</span> };<br/>
<span class="in1"></span><span class="var">cmd</span> = <span class="var">bytes</span>[<span class="num">0</span>];<br/>
<span class="macro">@End(<span class="name">disassemble</span>)</span><br/>
</code></div>
<ul><li>
get byte pointer to address
</li><li>
and the value of the first byte
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">15</div>
<code>
<span class="macro">@Add(<span class="name">disassemble</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0x3</span>) != <span class="num">0x3</span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">disassemble 16 bit</span>)</span><br/>
<span class="in2"></span><span class="var">addr</span> += <span class="num">2</span>;<br/>
<span class="in1"></span>} <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0xc</span>) != <span class="num">0xc</span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">disassemble 32 bit</span>)</span><br/>
<span class="in2"></span><span class="var">addr</span> += <span class="num">4</span>;<br/>
<span class="in1"></span>} <span class="keyword">else</span> {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">disassemble unknown</span>)</span><br/>
<span class="in2"></span><span class="var">addr</span> += <span class="num">2</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="fn">putnl</span>();<br/>
<span class="macro">@End(<span class="name">disassemble</span>)</span><br/>
</code></div>
<ul><li>
size of the command depends on the first bits of the first byte
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">16</div>
<code>
<span class="macro">@Add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">write_hex_bytes</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="var">uchr</span> *<span class="var">bytes</span>,<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">count</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">for</span> (; <span class="var">count</span>; --<span class="var">count</span>, ++<span class="var">bytes</span>) {<br/>
<span class="in3"></span><span class="fn">write_hex_byte</span>(*<span class="var">bytes</span>);<br/>
<span class="in3"></span><span class="fn">put</span>(<span class="str">' '</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
write multiple hexadecimal bytes
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">17</div>
<code>
<span class="macro">@def(<span class="name">disassemble 16 bit</span>)</span><br/>
<span class="in1"></span><span class="fn">write_hex_bytes</span>(<span class="var">bytes</span>, <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">"       "</span>);<br/>
<span class="in1"></span><span class="var">cmd</span> |= <span class="var">bytes</span>[<span class="num">1</span>] &lt;&lt; <span class="num">8</span>;<br/>
<span class="macro">@end(<span class="name">disassemble 16 bit</span>)</span><br/>
</code></div>
<ul><li>
write two bytes
</li><li>
and build two-byte command
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">18</div>
<code>
<span class="macro">@add(<span class="name">disassemble 16 bit</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">cmd</span> == <span class="num">0x0000</span>) {<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"db.s $0000 // illegal"</span>);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">16 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> {<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"db.s $"</span>);<br/>
<span class="in2"></span><span class="fn">write_hex_int</span>(<span class="var">cmd</span>, <span class="num">2</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">disassemble 16 bit</span>)</span><br/>
</code></div>
<ul><li>
disassemble two-byte command
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">19</div>
<code>
<span class="macro">@def(<span class="name">16 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0xe003</span>) == <span class="num">0x0001</span> &amp;&amp;<br/>
<span class="in2"></span>(<span class="var">cmd</span> &amp; <span class="num">0x0f80</span>)<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">add immediate 16</span>)</span><br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">16 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- <span class="var">reg</span> + <span class="var">immediate</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">20</div>
<code>
<span class="macro">@def(<span class="name">add immediate 16</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">reg</span> { (<span class="var">cmd</span> &amp; <span class="num">0x0f80</span>) &gt;&gt; <span class="num">7</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">immed</span> { (<span class="var">cmd</span> &amp; <span class="num">0x007c</span>) &gt;&gt; <span class="num">2</span> };<br/>
<span class="in1"></span><span class="fn">write_reg</span>(<span class="var">reg</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">" &lt;- "</span>);<br/>
<span class="in1"></span><span class="fn">write_reg</span>(<span class="var">reg</span>);<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">cmd</span> &amp; <span class="num">0x1000</span>) {<br/>
<span class="in2"></span><span class="var">immed</span> = (-<span class="var">immed</span>) &amp; <span class="num">0x1f</span>;<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" - $"</span>);<br/>
<span class="in1"></span>} <span class="keyword">else</span> {<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" + $"</span>);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="fn">write_hex_int</span>(<span class="var">immed</span>, -<span class="num">1</span>);<br/>
<span class="macro">@end(<span class="name">add immediate 16</span>)</span><br/>
</code></div>
<ul><li>
extract register and immediate value
</li><li>
handle negative immediate by negating the value
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">21</div>
<code>
<span class="macro">@add(<span class="name">16 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0xe003</span>) == <span class="num">0x4001</span> &amp;&amp;<br/>
<span class="in2"></span>(<span class="var">cmd</span> &amp; <span class="num">0x0f80</span>)<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">set immediate 16</span>)</span><br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">16 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- <span class="var">immediate</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">22</div>
<code>
<span class="macro">@def(<span class="name">set immediate 16</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">reg</span> { (<span class="var">cmd</span> &amp; <span class="num">0x0f80</span>) &gt;&gt; <span class="num">7</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">immed</span> { (<span class="var">cmd</span> &amp; <span class="num">0x007c</span>) &gt;&gt; <span class="num">2</span> };<br/>
<span class="in1"></span><span class="fn">write_reg</span>(<span class="var">reg</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">" &lt;- "</span>);<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">cmd</span> &amp; <span class="num">0x1000</span>) {<br/>
<span class="in2"></span><span class="var">immed</span> = (-<span class="var">immed</span>) &amp; <span class="num">0x1f</span>;<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"-$"</span>);<br/>
<span class="in1"></span>} <span class="keyword">else</span> {<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">'$'</span>);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="fn">write_hex_int</span>(<span class="var">immed</span>, -<span class="num">1</span>);<br/>
<span class="macro">@end(<span class="name">set immediate 16</span>)</span><br/>
</code></div>
<ul><li>
extract register and immediate value
</li><li>
handle negative immediate by negating the value
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">23</div>
<code>
<span class="macro">@add(<span class="name">16 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0xe003</span>) == <span class="num">0xc002</span>) {<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">reg</span> { (<span class="var">cmd</span> &amp; <span class="num">0x7c</span>) &gt;&gt; <span class="num">2</span> };<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">offset</span> {<br/>
<span class="in3"></span>((<span class="var">cmd</span> &amp; <span class="num">0x1e00</span>) &gt;&gt; (<span class="num">9</span> - <span class="num">2</span>)) |<br/>
<span class="in3"></span>((<span class="var">cmd</span> &amp; <span class="num">0x0180</span>) &gt;&gt; (<span class="num">7</span> - <span class="num">6</span>))<br/>
<span class="in2"></span>};<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"[%sp + $"</span>);<br/>
<span class="in2"></span><span class="fn">write_hex_int</span>(<span class="var">offset</span>, -<span class="num">1</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"] &lt;- "</span>);<br/>
<span class="in2"></span><span class="fn">write_reg</span>(<span class="var">reg</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">16 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code>[%<span class="var">sp</span> + <span class="var">immediate</span>] &lt;- <span class="var">reg</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">24</div>
<code>
<span class="macro">@add(<span class="name">16 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0xe003</span>) == <span class="num">0x4002</span>) {<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">reg</span> { (<span class="var">cmd</span> &amp; <span class="num">0x0f80</span>) &gt;&gt; <span class="num">7</span> };<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">offset</span> {<br/>
<span class="in3"></span>((<span class="var">cmd</span> &amp; <span class="num">0x0070</span>) &gt;&gt; (<span class="num">4</span> - <span class="num">2</span>)) |<br/>
<span class="in3"></span>((<span class="var">cmd</span> &amp; <span class="num">0x000c</span>) &lt;&lt; (<span class="num">6</span> - <span class="num">2</span>)) |<br/>
<span class="in3"></span>((<span class="var">cmd</span> &amp; <span class="num">0x1000</span>) &gt;&gt; (<span class="num">12</span> - <span class="num">5</span>))<br/>
<span class="in2"></span>};<br/>
<span class="in2"></span><span class="fn">write_reg</span>(<span class="var">reg</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" &lt;- [%sp + $"</span>);<br/>
<span class="in2"></span><span class="fn">write_hex_int</span>(<span class="var">offset</span>, -<span class="num">1</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">']'</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">16 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- [%<span class="var">sp</span> + <span class="var">immediate</span>]</code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">25</div>
<code>
<span class="macro">@add(<span class="name">16 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0xf003</span>) == <span class="num">0x8002</span> &amp;&amp;<br/>
<span class="in2"></span>(<span class="var">cmd</span> &amp; <span class="num">0x007c</span>)<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="fn">write_reg</span>((<span class="var">cmd</span> &amp; <span class="num">0x0f80</span>) &gt;&gt; <span class="num">7</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" &lt;- "</span>);<br/>
<span class="in2"></span><span class="fn">write_reg</span>((<span class="var">cmd</span> &amp; <span class="num">0x007c</span>) &gt;&gt; <span class="num">2</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">16 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- <span class="var">reg</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">26</div>
<code>
<span class="macro">@add(<span class="name">16 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0xf003</span>) == <span class="num">0x9002</span> &amp;&amp;<br/>
<span class="in2"></span>(<span class="var">cmd</span> &amp; <span class="num">0x007c</span>)<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="fn">write_reg</span>((<span class="var">cmd</span> &amp; <span class="num">0x0f80</span>) &gt;&gt; <span class="num">7</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" &lt;- "</span>);<br/>
<span class="in2"></span><span class="fn">write_reg</span>((<span class="var">cmd</span> &amp; <span class="num">0x0f80</span>) &gt;&gt; <span class="num">7</span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" + "</span>);<br/>
<span class="in2"></span><span class="fn">write_reg</span>((<span class="var">cmd</span> &amp; <span class="num">0x007c</span>) &gt;&gt; <span class="num">2</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">16 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- <span class="var">reg</span> + <span class="var">reg</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">27</div>
<code>
<span class="macro">@add(<span class="name">16 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> (<span class="var">cmd</span> == <span class="num">0x8082</span>) {<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"%pc &lt;- %ra // return"</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">16 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="keyword">return</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">28</div>
<code>
<span class="macro">@def(<span class="name">disassemble 32 bit</span>)</span><br/>
<span class="in1"></span><span class="fn">write_hex_bytes</span>(<span class="var">bytes</span>, <span class="num">4</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">' '</span>);<br/>
<span class="in1"></span><span class="var">cmd</span> |= <span class="var">bytes</span>[<span class="num">1</span>] &lt;&lt; <span class="num">8</span>;<br/>
<span class="in1"></span><span class="var">cmd</span> |= <span class="var">bytes</span>[<span class="num">2</span>] &lt;&lt; <span class="num">16</span>;<br/>
<span class="in1"></span><span class="var">cmd</span> |= <span class="var">bytes</span>[<span class="num">3</span>] &lt;&lt; <span class="num">24</span>;<br/>
<span class="macro">@end(<span class="name">disassemble 32 bit</span>)</span><br/>
</code></div>
<ul><li>
write four bytes
</li><li>
and generate full command
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">29</div>
<code>
<span class="macro">@add(<span class="name">disassemble 32 bit</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0xfe00707f</span>) ==<br/>
<span class="in2"></span><span class="num">0x00005033</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">shift right</span>)</span><br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">32 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> {<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">"db.w $"</span>);<br/>
<span class="in2"></span><span class="fn">write_hex_int</span>(<span class="var">cmd</span>, <span class="num">4</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">disassemble 32 bit</span>)</span><br/>
</code></div>
<ul><li>
disassemble 32 bit commands
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">30</div>
<code>
<span class="macro">@def(<span class="name">shift right</span>)</span><br/>
<span class="in1"></span><span class="fn">write_reg</span>((<span class="var">cmd</span> &amp; <span class="num">0x00000f80</span>) &gt;&gt; <span class="num">7</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">" &lt;- "</span>);<br/>
<span class="in1"></span><span class="fn">write_reg</span>((<span class="var">cmd</span> &amp; <span class="num">0x000f8000</span>) &gt;&gt; <span class="num">15</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">" &gt;&gt; "</span>);<br/>
<span class="in1"></span><span class="fn">write_reg</span>((<span class="var">cmd</span> &amp; <span class="num">0x01f00000</span>) &gt;&gt; <span class="num">20</span>);<br/>
<span class="macro">@end(<span class="name">shift right</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- <span class="var">reg</span> &gt;&gt; <span class="var">reg</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">31</div>
<code>
<span class="macro">@def(<span class="name">disassemble unknown</span>)</span><br/>
<span class="in1"></span><span class="fn">write_hex_bytes</span>(<span class="var">bytes</span>, <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">"       "</span>);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">"db.b $"</span>);<br/>
<span class="in1"></span><span class="fn">write_hex_byte</span>(<span class="var">bytes</span>[<span class="num">0</span>]);<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="str">" $"</span>);<br/>
<span class="in1"></span><span class="fn">write_hex_byte</span>(<span class="var">bytes</span>[<span class="num">1</span>]);<br/>
<span class="macro">@end(<span class="name">disassemble unknown</span>)</span><br/>
</code></div>
<ul><li>
write unknown 32 bit sequence
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">32</div>
<code>
<span class="macro">@def(<span class="name">32 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0x0000707f</span>) ==<br/>
<span class="in2"></span><span class="num">0x00007013</span>) {<br/>
<span class="in2"></span><span class="fn">write_reg</span>(<br/>
<span class="in3"></span>(<span class="var">cmd</span> &amp; <span class="num">0x00000f80</span>) &gt;&gt; <span class="num">7</span><br/>
<span class="in2"></span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" &lt;- "</span>);<br/>
<span class="in2"></span><span class="fn">write_reg</span>(<br/>
<span class="in3"></span>(<span class="var">cmd</span> &amp; <span class="num">0x000f8000</span>) &gt;&gt; <span class="num">14</span><br/>
<span class="in2"></span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" and $"</span>);<br/>
<span class="in2"></span><span class="fn">write_hex_int</span>(<br/>
<span class="in3"></span>(<span class="var">cmd</span> &amp; <span class="num">0xfff00000</span>) &gt;&gt; <span class="num">20</span>, -<span class="num">1</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">32 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- <span class="var">reg</span> <span class="var">and</span> <span class="var">immediate</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">33</div>
<code>
<span class="macro">@add(<span class="name">32 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0x0000007f</span>) ==<br/>
<span class="in2"></span><span class="num">0x00000037</span>) {<br/>
<span class="in2"></span><span class="fn">write_reg</span>(<br/>
<span class="in3"></span>(<span class="var">cmd</span> &amp; <span class="num">0x00000f80</span>) &gt;&gt; <span class="num">7</span><br/>
<span class="in2"></span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" &lt;- $"</span>);<br/>
<span class="in2"></span><span class="fn">write_addr</span>(<span class="var">cmd</span> &amp; <span class="num">0xfffff000</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">32 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- <span class="var">immediate</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">34</div>
<code>
<span class="macro">@add(<span class="name">32 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0x0000007f</span>) ==<br/>
<span class="in2"></span><span class="num">0x00000017</span>) {<br/>
<span class="in2"></span><span class="fn">write_reg</span>(<br/>
<span class="in3"></span>(<span class="var">cmd</span> &amp; <span class="num">0x00000f80</span>) &gt;&gt; <span class="num">7</span><br/>
<span class="in2"></span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" &lt;- %pc "</span>);<br/>
<span class="in2"></span><span class="var">ulong</span> <span class="var">target</span>;<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">cmd</span> &amp; <span class="num">0x80000000</span>) {<br/>
<span class="in3"></span><span class="fn">put</span>(<span class="str">"- $"</span>);<br/>
<span class="in3"></span><span class="fn">write_addr</span>(-(<span class="var">cmd</span> &amp; <span class="num">0x7ffff000</span>) &amp; <span class="num">0x7ffff000</span>);<br/>
<span class="in3"></span><span class="var">target</span> = <span class="var">addr</span> - (<span class="var">cmd</span> &amp; <span class="num">0x7ffff000</span>);<br/>
<span class="in2"></span>} <span class="keyword">else</span> {<br/>
<span class="in3"></span><span class="fn">put</span>(<span class="str">"+ $"</span>);<br/>
<span class="in3"></span><span class="fn">write_addr</span>(<span class="var">cmd</span> &amp; <span class="num">0x7ffff000</span>);<br/>
<span class="in3"></span><span class="var">target</span> = <span class="var">addr</span> + (<span class="var">cmd</span> &amp; <span class="num">0x7ffff000</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" // $"</span>);<br/>
<span class="in2"></span><span class="fn">write_addr</span>(<span class="var">target</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">32 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span> &lt;- %<span class="var">pc</span> + <span class="var">immediate</span></code>
</li></ul>
</div>
<div class="page"><div class="slide"><div class="slide-nr">35</div>
<code>
<span class="macro">@add(<span class="name">32 bit cases</span>)</span><br/>
<span class="in1"></span><span class="keyword">else</span> <span class="keyword">if</span> ((<span class="var">cmd</span> &amp; <span class="num">0x0000707f</span>) ==<br/>
<span class="in2"></span><span class="num">0x00000067</span>) {<br/>
<span class="in2"></span><span class="fn">write_reg</span>(<br/>
<span class="in3"></span>(<span class="var">cmd</span> &amp; <span class="num">0x00000f80</span>) &gt;&gt; <span class="num">7</span><br/>
<span class="in2"></span>);<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">", %pc &lt;- %pc + $04, %pc "</span>);<br/>
<span class="in2"></span><span class="var">ulong</span> <span class="var">target</span>;<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">cmd</span> &amp; <span class="num">0x80000000</span>) {<br/>
<span class="in3"></span><span class="fn">put</span>(<span class="str">"- $"</span>);<br/>
<span class="in3"></span><span class="fn">write_hex_int</span>(-(<span class="var">cmd</span> &gt;&gt; <span class="num">20</span>) &amp; <span class="num">0x3ff</span>, -<span class="num">1</span>);<br/>
<span class="in3"></span><span class="var">target</span> = <span class="var">addr</span> - ((<span class="var">cmd</span> &gt;&gt; <span class="num">20</span>) &amp; <span class="num">0x3ff</span>);<br/>
<span class="in2"></span>} <span class="keyword">else</span> {<br/>
<span class="in3"></span><span class="fn">put</span>(<span class="str">"+ $"</span>);<br/>
<span class="in3"></span><span class="fn">write_hex_int</span>((<span class="var">cmd</span> &gt;&gt; <span class="num">20</span>) &amp; <span class="num">0x3ff</span>, -<span class="num">1</span>);<br/>
<span class="in3"></span><span class="var">target</span> = <span class="var">addr</span> + ((<span class="var">cmd</span> &gt;&gt; <span class="num">20</span>) &amp; <span class="num">0x3ff</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="str">" // $"</span>);<br/>
<span class="in2"></span><span class="fn">write_addr</span>(<span class="var">target</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">32 bit cases</span>)</span><br/>
</code></div>
<ul><li>
disassemble <code><span class="var">reg</span>, %<span class="var">pc</span> &lt;- %<span class="var">pc</span> + <span class="var">$04</span>, %<span class="var">pc</span> + <span class="var">immediate</span></code>
</li></ul>
</div>
</body>
</html>
